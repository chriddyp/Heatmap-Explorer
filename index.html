<!DOCTYPE HTML>
<html>
<title>Heatmap and Contour Plot Explorer</title>
<head>
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/base-min.css">
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/pure-min.css">
    <meta name="description" content="Interactively view x, y slices through heatmaps and contour plots online with Plotly.">
</head>

<body style="font-family: 'Open Sans', serif; background: #edf1f8">
    <div class="pure-g">
        <div class="pure-u-7-24">
            <div style="margin: 0 2em 0; text-align: right;">
                <h1 style="text-transform: uppercase; color: #447bdc;">
                    Interactive Heatmaps
                </h1>

                <h2 style="font-weight: 300; color: #1d3b84; opacity: 0.5">
                    click on a heatmap cell to view an x, y slice through your cursor
                </h2>

                <form class="pure-form pure-g">
                    <div class="pure-u-1-5"></div>
                    <div class="pure-u-4-5">
                        <input
                            class="pure-input-1"
                            placeholder="https://plot.ly/~chris/5496"
                            value="https://plot.ly/~chris/5496">
                        <p class="input-error" style="display:none"></p>
                    </div>
                </form>

                <a class="pure-button"
                    style="
                        background: transparent;
                        border: 2px solid rgb(176, 202, 219);
                        color: color: #1d3b84;
                        opacity: 0.5;
                        margin-top: 1em;
                        letter-spacing: 0.05em;
                        text-transform: uppercase;
                        font-size: 85%;"
                    id="newGraph" href="#">load graph</a>

                <div class="pure-u-1">
                    <div style="font-weight: 400; color: #69738a; margin-top: 80%">
                        This example binds custom interactivity client-side with JavaScript with
                        <a style="color: #8c97af; text-decoration: none;" href="https://github.com/plotly/Embed-API">
                        Plotly's postMessage embed API</a>. Any plotly heatmap or contour plot
                        will work.<br><br>
                        Try another URL<div><code>https://plot.ly/~BrillionNerd/3</code></div><div><code>https://plot.ly/~joaoduarte/14</code></div>.
                    </div>
                </div>

            </div>
        </div>

        <div class="pure-u-17-24">
            <iframe id="heatmap"
                    src="https://plot.ly/~chris/5496.embed"
                    style="width:100%; height:600px; border:none"
                    seamless>
            </iframe>
        </div>
    </div>

    <script type="text/javascript" charset="utf-8">

        function update(){
            var graphUrl = $('input').val();
            var urlParts = graphUrl.split('/');
            var plotlyDomain = urlParts[0] + '//' + urlParts[2];

            function init_graph_obj(id, plotlyDomain){
                var obj = {
                    graphContentWindow: $('#'+id)[0].contentWindow,
                    id: id
                };
                obj['pinger'] = setInterval(function(){
                    obj.graphContentWindow.postMessage({task: 'ping'}, plotlyDomain);
                }, 500);
                return obj;
            }

            $('#graph').attr('src', graphUrl);

            window.graphs = {
                'heatmap': init_graph_obj('heatmap', plotlyDomain)
            };

            window.graphs.heatmap['pong'] = function(message){
                console.log('registering pong');
                window.graphs.heatmap.graphContentWindow.postMessage({'task': 'getAttributes'}, plotlyDomain);
                window.graphs.heatmap.graphContentWindow.postMessage({
                    'task': 'listen',
                    'events': ['click']},
                plotlyDomain);
            };

            window.graphs.heatmap['click'] = function(message){
                console.log('>> click');
                if(!('hasClicked' in window.graphs.heatmap)){
                    window.graphs.heatmap.graphContentWindow.postMessage({
                        'task': 'addTraces',
                        'traces': [
                            {'x': [], 'y': [], 'xaxis': 'x', 'yaxis': 'y2'},
                            {'x': [], 'y': [], 'xaxis': 'x2', 'yaxis': 'y'}
                        ]
                    }, plotlyDomain);
                    window.graphs.heatmap.graphContentWindow.postMessage({
                        'task': 'relayout',
                        'update': {
                            'xaxis.domain': [0, 0.75],
                            'xaxis2': {
                                'domain': [0.75, 1],
                                'anchor': 'y'
                            },
                            'yaxis.domain': [0, 0.75],
                            'yaxis2': {
                                'domain': [0.75, 1],
                                'anchor': 'x'
                            },
                            'margin.r': 0,
                            'margin.b': 0,
                            'paper_bgcolor': '#edf1f8',
                            'plot_bgcolor': '#edf1f8',
                            'showlegend': false,
                            'hidesources': true
                        }
                    }, plotlyDomain);
                    window.graphs.heatmap.hasClicked = true;
                }
                var xi = message.points[0]['pointNumber'][0];
                var yi = message.points[0]['pointNumber'][1];
                var trace = window.graphs.heatmap.fig['data'][0];
                var z = trace.z;
                var zAlongX = z[xi];
                var zAlongY = [];
                for(var i in z){
                    zAlongY.push(z[i][yi]);
                }
                var xs = ('x' in trace ? trace.x : range(zAlongX.length));
                var ys = ('y' in trace ? trace.y : range(zAlongY.length));

                window.graphs.heatmap.graphContentWindow.postMessage({
                    'task': 'restyle',
                    'update': {'x': [xs, zAlongY], 'y': [zAlongX, ys], 'marker.color': '#69738a'},
                    'indices': [1,2]
                }, plotlyDomain);


                window.graphs.heatmap.graphContentWindow.postMessage({
                    'task': 'relayout',
                    'update': {
                        'yaxis2.title': 'z (y = '+message.points[0]['y']+')',
                        'xaxis2.title': 'z (x = '+message.points[0]['x']+')',
                    }
                }, plotlyDomain)
            };

            window.removeEventListener('message', messageListener);
            window.addEventListener('message', messageListener);
        }

        function range(N){
            var x = [];
            for(var i=0; i<N; i++){
                x.push(i);
            }
            return x;
        }

        update();
        $('#newGraph').click(function(){
            var url = $('input').val();
            $('.input-error').text("");
            if(url.split('/').length-1 !== 4){
                $('.input-error').text("Woops! That URL doesn't look like it's in the right form. Here's an example of a valid URL: https://plot.ly/~cimar/200");
                $('.input-error').show();
                return;
            }
            $('#heatmap').attr('src', url+'.embed');
            update();
        });

        function messageListener(e) {
            var message = e.data;
            console.log('message: ', message);

            for(graph_id in window.graphs){
                if(window.graphs[graph_id].graphContentWindow === e.source) {
                    var graph = window.graphs[graph_id];
                    break;
                }
            }

            var pinger = graph.pinger;
            var graphContentWindow = graph.graphContentWindow;
            var id = graph.id;

            if('pong' in message && message.pong) {
                console.log('>> pong');
                clearInterval(pinger);
                if('pong' in graph){
                    graph.pong();
                }
            } else if (message.type==='hover' ||
                        message.type==='zoom'  ||
                        message.type==='click') {
                console.log('>> ', message.type);
                if(message.type !== 'zoom') {
                    for(var i in message.points) {
                        delete message.points[i].data;
                    }
                }

                if(message.type in graph) {
                    graph[message.type](message);
                }

            } else if(message.task==='getAttributes'){
                console.log('>> getAttributes');
                graph['fig'] = message.response;
            }
        };

    </script>

</body>

</html>
